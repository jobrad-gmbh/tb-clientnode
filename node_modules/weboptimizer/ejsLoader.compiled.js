#!/usr/bin/env node


// -*- coding: utf-8 -*-
'use strict';
/* !
    region header
    Copyright Torben Sickert (info["~at~"]torben.website) 16.12.2012

    License
    -------

    This library written by Torben Sickert stand under a creative commons naming
    3.0 unported license. see http://creativecommons.org/licenses/by/3.0/deed.de
    endregion
*/
// region imports

var _babelCore = require('babel-core');

var _babelPresetBabili = require('babel-preset-babili');

var _babelPresetBabili2 = _interopRequireDefault(_babelPresetBabili);

var _babelPluginTransformWith = require('babel-plugin-transform-with');

var _babelPluginTransformWith2 = _interopRequireDefault(_babelPluginTransformWith);

var _clientnode = require('clientnode');

var _clientnode2 = _interopRequireDefault(_clientnode);

var _ejs = require('ejs');

var ejs = _interopRequireWildcard(_ejs);

var _fs = require('fs');

var fileSystem = _interopRequireWildcard(_fs);

var _htmlMinifier = require('html-minifier');

var _loaderUtils = require('loader-utils');

var loaderUtils = _interopRequireWildcard(_loaderUtils);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _configurator = require('./configurator.compiled');

var _configurator2 = _interopRequireDefault(_configurator);

var _helper = require('./helper.compiled');

var _helper2 = _interopRequireDefault(_helper);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// NOTE: Only needed for debugging this file.
try {
    require('source-map-support/register');
} catch (error) {}
// endregion

// endregion
// region types
module.exports = function (source) {
    if ('cachable' in this && this.cacheable) this.cacheable();
    const query = _clientnode2.default.convertSubstringInPlainObject(_clientnode2.default.extendObject(true, {
        compress: {
            html: {},
            javaScript: {}
        },
        context: './',
        extensions: {
            file: {
                external: ['.js'],
                internal: ['.js', '.css', '.svg', '.png', '.jpg', '.gif', '.ico', '.html', '.json', '.eot', '.ttf', '.woff']
            }, module: []
        },
        module: {
            aliases: {},
            replacements: {}
        },
        compileSteps: 2
    }, this.options || {}, 'query' in this ? loaderUtils.getOptions(this) || {} : {}), /#%%%#/g, '!');
    const compile = (template, options = query.compiler, compileSteps = 2) => (locals = {}) => {
        options = _clientnode2.default.extendObject(true, { filename: template }, options);
        const require = (request, nestedLocals = {}) => {
            const template = request.replace(/^(.+)\?[^?]+$/, '$1');
            const queryMatch = request.match(/^[^?]+\?(.+)$/);
            if (queryMatch) {
                const evaluationFunction = (request, template, source, compile, locals) => new Function('request', 'template', 'source', 'compile', 'locals', `return ${queryMatch[1]}`)(request, template, source, compile, locals);
                nestedLocals = _clientnode2.default.extendObject(true, nestedLocals, evaluationFunction(request, template, source, compile, locals));
            }
            let nestedOptions = _clientnode2.default.copyLimitedRecursively(options);
            delete nestedOptions.client;
            nestedOptions = _clientnode2.default.extendObject(true, { encoding: _configurator2.default.encoding }, nestedOptions, nestedLocals.options || {});
            if (nestedOptions.isString) return compile(template, nestedOptions)(nestedLocals);
            const templateFilePath = _helper2.default.determineModuleFilePath(template, query.module.aliases, query.module.replacements, query.extensions, query.context, _configurator2.default.path.source.asset.base, _configurator2.default.path.ignore, _configurator2.default.module.directoryNames, _configurator2.default.package.main.fileNames, _configurator2.default.package.main.propertyNames, _configurator2.default.package.aliasPropertyNames, _configurator2.default.encoding);
            if (templateFilePath) {
                if ('query' in this) this.addDependency(templateFilePath);
                /*
                    NOTE: If there aren't any locals options or variables and
                    file doesn't seem to be an ejs template we simply load
                    included file content.
                */
                if (queryMatch || templateFilePath.endsWith('.ejs')) return compile(templateFilePath, nestedOptions)(nestedLocals);
                // IgnoreTypeCheck
                return fileSystem.readFileSync(templateFilePath, nestedOptions);
            }
            throw new Error(`Given template file "${template}" couldn't be resolved.`);
        };
        const compressHTML = content => query.compress.html ? (0, _htmlMinifier.minify)(content, _clientnode2.default.extendObject(true, {
            caseSensitive: true,
            collapseInlineTagWhitespace: true,
            collapseWhitespace: true,
            conservativeCollapse: true,
            minifyCSS: true,
            minifyJS: true,
            processScripts: ['text/ng-template', 'text/x-handlebars-template'],
            removeAttributeQuotes: true,
            removeComments: true,
            removeRedundantAttributes: true,
            removeScriptTypeAttributes: true,
            removeStyleLinkTypeAttributes: true,
            sortAttributes: true,
            sortClassName: true,
            // NOTE: Avoids whitespace around placeholder in tags.
            trimCustomFragments: true,
            useShortDoctype: true
        }, query.compress.html)) : content;
        let remainingSteps = compileSteps;
        let result = template;
        let isString = options.isString;
        delete options.isString;
        while (remainingSteps > 0) {
            if (typeof result === 'string') {
                const filePath = isString && options.filename || result;
                if (filePath && _path2.default.extname(filePath) === '.js') result = eval('require')(filePath);else {
                    if (!isString) {
                        let encoding = _configurator2.default.encoding;
                        if ('encoding' in options) encoding = options.encoding;
                        result = fileSystem.readFileSync(result, { encoding });
                    }
                    if (remainingSteps === 1) result = compressHTML(result);
                    result = ejs.compile(result, options);
                }
            } else result = compressHTML(result(_clientnode2.default.extendObject(true, {
                configuration: _configurator2.default, Helper: _helper2.default, include: require, require, Tools: _clientnode2.default
            }, locals)));
            remainingSteps -= 1;
        }
        if (Boolean(compileSteps % 2)) return `'use strict';\n` + (0, _babelCore.transform)(`module.exports = ${result.toString()};`, {
            ast: false,
            babelrc: false,
            comments: !Boolean(query.compress.javaScript),
            compact: Boolean(query.compress.javaScript),
            filename: options.filename || 'unknown',
            minified: Boolean(query.compress.javaScript),
            plugins: [_babelPluginTransformWith2.default],
            presets: query.compress.javaScript ? [[_babelPresetBabili2.default, query.compress.javaScript]] : [],
            sourceMaps: false,
            sourceType: 'script'
        }).code;
        // IgnoreTypeCheck
        return result;
    };
    return compile(source, {
        client: Boolean(query.compileSteps % 2),
        compileDebug: this.debug || false,
        debug: this.debug || false,
        filename: 'query' in this ? loaderUtils.getRemainingRequest(this).replace(/^!/, '') : this.filename || null,
        isString: true
    }, query.compileSteps)(query.locals || {});
};
// region vim modline
// vim: set tabstop=4 shiftwidth=4 expandtab:
// vim: foldmethod=marker foldmarker=region,endregion:
// endregion

//# sourceMappingURL=data:application/json;charset=utf-8;base64,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TnBCO0FBT25CLGtCQUFVO0FBUFMsS0FBaEIsRUFRSixNQUFNLFlBUkYsRUFRZ0IsTUFBTSxNQUFOLElBQWdCLEVBUmhDLENBQVA7QUFTSCxDQW5LRDtBQW9LQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJlanNMb2FkZXIuY29tcGlsZWQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8vIEBmbG93XG4vLyAtKi0gY29kaW5nOiB1dGYtOCAtKi1cbid1c2Ugc3RyaWN0J1xuLyogIVxuICAgIHJlZ2lvbiBoZWFkZXJcbiAgICBDb3B5cmlnaHQgVG9yYmVuIFNpY2tlcnQgKGluZm9bXCJ+YXR+XCJddG9yYmVuLndlYnNpdGUpIDE2LjEyLjIwMTJcblxuICAgIExpY2Vuc2VcbiAgICAtLS0tLS0tXG5cbiAgICBUaGlzIGxpYnJhcnkgd3JpdHRlbiBieSBUb3JiZW4gU2lja2VydCBzdGFuZCB1bmRlciBhIGNyZWF0aXZlIGNvbW1vbnMgbmFtaW5nXG4gICAgMy4wIHVucG9ydGVkIGxpY2Vuc2UuIHNlZSBodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9saWNlbnNlcy9ieS8zLjAvZGVlZC5kZVxuICAgIGVuZHJlZ2lvblxuKi9cbi8vIHJlZ2lvbiBpbXBvcnRzXG5pbXBvcnQge3RyYW5zZm9ybSBhcyBiYWJlbFRyYW5zZm9ybX0gZnJvbSAnYmFiZWwtY29yZSdcbmltcG9ydCBiYWJpbGlQcmVzZXQgZnJvbSAnYmFiZWwtcHJlc2V0LWJhYmlsaSdcbmltcG9ydCB0cmFuc2Zvcm1XaXRoIGZyb20gJ2JhYmVsLXBsdWdpbi10cmFuc2Zvcm0td2l0aCdcbmltcG9ydCBUb29scyBmcm9tICdjbGllbnRub2RlJ1xuaW1wb3J0ICogYXMgZWpzIGZyb20gJ2VqcydcbmltcG9ydCAqIGFzIGZpbGVTeXN0ZW0gZnJvbSAnZnMnXG5pbXBvcnQge21pbmlmeSBhcyBtaW5pZnlIVE1MfSBmcm9tICdodG1sLW1pbmlmaWVyJ1xuaW1wb3J0ICogYXMgbG9hZGVyVXRpbHMgZnJvbSAnbG9hZGVyLXV0aWxzJ1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbi8vIE5PVEU6IE9ubHkgbmVlZGVkIGZvciBkZWJ1Z2dpbmcgdGhpcyBmaWxlLlxudHJ5IHtcbiAgICByZXF1aXJlKCdzb3VyY2UtbWFwLXN1cHBvcnQvcmVnaXN0ZXInKVxufSBjYXRjaCAoZXJyb3IpIHt9XG5cbmltcG9ydCBjb25maWd1cmF0aW9uIGZyb20gJy4vY29uZmlndXJhdG9yLmNvbXBpbGVkJ1xuaW1wb3J0IEhlbHBlciBmcm9tICcuL2hlbHBlci5jb21waWxlZCdcbi8vIGVuZHJlZ2lvblxuLy8gcmVnaW9uIHR5cGVzXG50eXBlIFRlbXBsYXRlRnVuY3Rpb24gPSAobG9jYWxzOk9iamVjdCkgPT4gc3RyaW5nXG50eXBlIENvbXBpbGVGdW5jdGlvbiA9IChcbiAgICB0ZW1wbGF0ZTpzdHJpbmcsIG9wdGlvbnM6T2JqZWN0LCBjb21waWxlU3RlcHM/Om51bWJlclxuKSA9PiBUZW1wbGF0ZUZ1bmN0aW9uXG4vLyBlbmRyZWdpb25cbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oc291cmNlOnN0cmluZyk6c3RyaW5nIHtcbiAgICBpZiAoJ2NhY2hhYmxlJyBpbiB0aGlzICYmIHRoaXMuY2FjaGVhYmxlKVxuICAgICAgICB0aGlzLmNhY2hlYWJsZSgpXG4gICAgY29uc3QgcXVlcnk6T2JqZWN0ID0gVG9vbHMuY29udmVydFN1YnN0cmluZ0luUGxhaW5PYmplY3QoXG4gICAgICAgIFRvb2xzLmV4dGVuZE9iamVjdCh0cnVlLCB7XG4gICAgICAgICAgICBjb21wcmVzczoge1xuICAgICAgICAgICAgICAgIGh0bWw6IHt9LFxuICAgICAgICAgICAgICAgIGphdmFTY3JpcHQ6IHt9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgY29udGV4dDogJy4vJyxcbiAgICAgICAgICAgIGV4dGVuc2lvbnM6IHtcbiAgICAgICAgICAgICAgICBmaWxlOiB7XG4gICAgICAgICAgICAgICAgICAgIGV4dGVybmFsOiBbJy5qcyddLFxuICAgICAgICAgICAgICAgICAgICBpbnRlcm5hbDogW1xuICAgICAgICAgICAgICAgICAgICAgICAgJy5qcycsICcuY3NzJywgJy5zdmcnLCAnLnBuZycsICcuanBnJywgJy5naWYnLCAnLmljbycsXG4gICAgICAgICAgICAgICAgICAgICAgICAnLmh0bWwnLCAnLmpzb24nLCAnLmVvdCcsICcudHRmJywgJy53b2ZmJ1xuICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgfSwgbW9kdWxlOiBbXVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG1vZHVsZToge1xuICAgICAgICAgICAgICAgIGFsaWFzZXM6IHt9LFxuICAgICAgICAgICAgICAgIHJlcGxhY2VtZW50czoge31cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjb21waWxlU3RlcHM6IDJcbiAgICAgICAgfSwgdGhpcy5vcHRpb25zIHx8IHt9LCAncXVlcnknIGluIHRoaXMgPyBsb2FkZXJVdGlscy5nZXRPcHRpb25zKFxuICAgICAgICAgICAgdGhpc1xuICAgICAgICApIHx8IHt9IDoge30pLFxuICAgICAgICAvIyUlJSMvZywgJyEnKVxuICAgIGNvbnN0IGNvbXBpbGU6Q29tcGlsZUZ1bmN0aW9uID0gKFxuICAgICAgICB0ZW1wbGF0ZTpzdHJpbmcsIG9wdGlvbnM6T2JqZWN0ID0gcXVlcnkuY29tcGlsZXIsXG4gICAgICAgIGNvbXBpbGVTdGVwczpudW1iZXIgPSAyXG4gICAgKTpUZW1wbGF0ZUZ1bmN0aW9uID0+IChsb2NhbHM6T2JqZWN0ID0ge30pOnN0cmluZyA9PiB7XG4gICAgICAgIG9wdGlvbnMgPSBUb29scy5leHRlbmRPYmplY3QodHJ1ZSwge2ZpbGVuYW1lOiB0ZW1wbGF0ZX0sIG9wdGlvbnMpXG4gICAgICAgIGNvbnN0IHJlcXVpcmU6RnVuY3Rpb24gPSAoXG4gICAgICAgICAgICByZXF1ZXN0OnN0cmluZywgbmVzdGVkTG9jYWxzOk9iamVjdCA9IHt9XG4gICAgICAgICk6c3RyaW5nID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlOnN0cmluZyA9IHJlcXVlc3QucmVwbGFjZSgvXiguKylcXD9bXj9dKyQvLCAnJDEnKVxuICAgICAgICAgICAgY29uc3QgcXVlcnlNYXRjaDo/QXJyYXk8c3RyaW5nPiA9IHJlcXVlc3QubWF0Y2goL15bXj9dK1xcPyguKykkLylcbiAgICAgICAgICAgIGlmIChxdWVyeU1hdGNoKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZXZhbHVhdGlvbkZ1bmN0aW9uID0gKFxuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0OnN0cmluZywgdGVtcGxhdGU6c3RyaW5nLCBzb3VyY2U6c3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICBjb21waWxlOkNvbXBpbGVGdW5jdGlvbiwgbG9jYWxzOk9iamVjdFxuICAgICAgICAgICAgICAgIC8vIElnbm9yZVR5cGVDaGVja1xuICAgICAgICAgICAgICAgICk6T2JqZWN0ID0+IG5ldyBGdW5jdGlvbihcbiAgICAgICAgICAgICAgICAgICAgJ3JlcXVlc3QnLCAndGVtcGxhdGUnLCAnc291cmNlJywgJ2NvbXBpbGUnLCAnbG9jYWxzJyxcbiAgICAgICAgICAgICAgICAgICAgYHJldHVybiAke3F1ZXJ5TWF0Y2hbMV19YFxuICAgICAgICAgICAgICAgICkocmVxdWVzdCwgdGVtcGxhdGUsIHNvdXJjZSwgY29tcGlsZSwgbG9jYWxzKVxuICAgICAgICAgICAgICAgIG5lc3RlZExvY2FscyA9IFRvb2xzLmV4dGVuZE9iamVjdChcbiAgICAgICAgICAgICAgICAgICAgdHJ1ZSwgbmVzdGVkTG9jYWxzLCBldmFsdWF0aW9uRnVuY3Rpb24oXG4gICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LCB0ZW1wbGF0ZSwgc291cmNlLCBjb21waWxlLCBsb2NhbHMpKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IG5lc3RlZE9wdGlvbnM6T2JqZWN0ID0gVG9vbHMuY29weUxpbWl0ZWRSZWN1cnNpdmVseShvcHRpb25zKVxuICAgICAgICAgICAgZGVsZXRlIG5lc3RlZE9wdGlvbnMuY2xpZW50XG4gICAgICAgICAgICBuZXN0ZWRPcHRpb25zID0gVG9vbHMuZXh0ZW5kT2JqZWN0KFxuICAgICAgICAgICAgICAgIHRydWUsIHtlbmNvZGluZzogY29uZmlndXJhdGlvbi5lbmNvZGluZ30sIG5lc3RlZE9wdGlvbnMsXG4gICAgICAgICAgICAgICAgbmVzdGVkTG9jYWxzLm9wdGlvbnMgfHwge30pXG4gICAgICAgICAgICBpZiAobmVzdGVkT3B0aW9ucy5pc1N0cmluZylcbiAgICAgICAgICAgICAgICByZXR1cm4gY29tcGlsZSh0ZW1wbGF0ZSwgbmVzdGVkT3B0aW9ucykobmVzdGVkTG9jYWxzKVxuICAgICAgICAgICAgY29uc3QgdGVtcGxhdGVGaWxlUGF0aDo/c3RyaW5nID1cbiAgICAgICAgICAgICAgICBIZWxwZXIuZGV0ZXJtaW5lTW9kdWxlRmlsZVBhdGgoXG4gICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLCBxdWVyeS5tb2R1bGUuYWxpYXNlcyxcbiAgICAgICAgICAgICAgICAgICAgcXVlcnkubW9kdWxlLnJlcGxhY2VtZW50cywgcXVlcnkuZXh0ZW5zaW9ucyxcbiAgICAgICAgICAgICAgICAgICAgcXVlcnkuY29udGV4dCwgY29uZmlndXJhdGlvbi5wYXRoLnNvdXJjZS5hc3NldC5iYXNlLFxuICAgICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uLnBhdGguaWdub3JlLFxuICAgICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uLm1vZHVsZS5kaXJlY3RvcnlOYW1lcyxcbiAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbi5wYWNrYWdlLm1haW4uZmlsZU5hbWVzLFxuICAgICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uLnBhY2thZ2UubWFpbi5wcm9wZXJ0eU5hbWVzLFxuICAgICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uLnBhY2thZ2UuYWxpYXNQcm9wZXJ0eU5hbWVzLFxuICAgICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uLmVuY29kaW5nKVxuICAgICAgICAgICAgaWYgKHRlbXBsYXRlRmlsZVBhdGgpIHtcbiAgICAgICAgICAgICAgICBpZiAoJ3F1ZXJ5JyBpbiB0aGlzKVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZERlcGVuZGVuY3kodGVtcGxhdGVGaWxlUGF0aClcbiAgICAgICAgICAgICAgICAvKlxuICAgICAgICAgICAgICAgICAgICBOT1RFOiBJZiB0aGVyZSBhcmVuJ3QgYW55IGxvY2FscyBvcHRpb25zIG9yIHZhcmlhYmxlcyBhbmRcbiAgICAgICAgICAgICAgICAgICAgZmlsZSBkb2Vzbid0IHNlZW0gdG8gYmUgYW4gZWpzIHRlbXBsYXRlIHdlIHNpbXBseSBsb2FkXG4gICAgICAgICAgICAgICAgICAgIGluY2x1ZGVkIGZpbGUgY29udGVudC5cbiAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgIGlmIChxdWVyeU1hdGNoIHx8IHRlbXBsYXRlRmlsZVBhdGguZW5kc1dpdGgoJy5lanMnKSlcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXBpbGUodGVtcGxhdGVGaWxlUGF0aCwgbmVzdGVkT3B0aW9ucykoXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXN0ZWRMb2NhbHMpXG4gICAgICAgICAgICAgICAgLy8gSWdub3JlVHlwZUNoZWNrXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpbGVTeXN0ZW0ucmVhZEZpbGVTeW5jKHRlbXBsYXRlRmlsZVBhdGgsIG5lc3RlZE9wdGlvbnMpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgYEdpdmVuIHRlbXBsYXRlIGZpbGUgXCIke3RlbXBsYXRlfVwiIGNvdWxkbid0IGJlIHJlc29sdmVkLmApXG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY29tcHJlc3NIVE1MOkZ1bmN0aW9uID0gKGNvbnRlbnQ6c3RyaW5nKTpzdHJpbmcgPT5cbiAgICAgICAgICAgIHF1ZXJ5LmNvbXByZXNzLmh0bWwgPyBtaW5pZnlIVE1MKGNvbnRlbnQsIFRvb2xzLmV4dGVuZE9iamVjdChcbiAgICAgICAgICAgICAgICB0cnVlLCB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2VTZW5zaXRpdmU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGNvbGxhcHNlSW5saW5lVGFnV2hpdGVzcGFjZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgY29sbGFwc2VXaGl0ZXNwYWNlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBjb25zZXJ2YXRpdmVDb2xsYXBzZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgbWluaWZ5Q1NTOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBtaW5pZnlKUzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc1NjcmlwdHM6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICd0ZXh0L25nLXRlbXBsYXRlJywgJ3RleHQveC1oYW5kbGViYXJzLXRlbXBsYXRlJ1xuICAgICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgICAgICByZW1vdmVBdHRyaWJ1dGVRdW90ZXM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZUNvbW1lbnRzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICByZW1vdmVSZWR1bmRhbnRBdHRyaWJ1dGVzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICByZW1vdmVTY3JpcHRUeXBlQXR0cmlidXRlczogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlU3R5bGVMaW5rVHlwZUF0dHJpYnV0ZXM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIHNvcnRBdHRyaWJ1dGVzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBzb3J0Q2xhc3NOYW1lOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAvLyBOT1RFOiBBdm9pZHMgd2hpdGVzcGFjZSBhcm91bmQgcGxhY2Vob2xkZXIgaW4gdGFncy5cbiAgICAgICAgICAgICAgICAgICAgdHJpbUN1c3RvbUZyYWdtZW50czogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgdXNlU2hvcnREb2N0eXBlOiB0cnVlXG4gICAgICAgICAgICAgICAgfSwgcXVlcnkuY29tcHJlc3MuaHRtbCkpIDogY29udGVudFxuICAgICAgICBsZXQgcmVtYWluaW5nU3RlcHM6bnVtYmVyID0gY29tcGlsZVN0ZXBzXG4gICAgICAgIGxldCByZXN1bHQ6VGVtcGxhdGVGdW5jdGlvbnxzdHJpbmcgPSB0ZW1wbGF0ZVxuICAgICAgICBsZXQgaXNTdHJpbmc6Ym9vbGVhbiA9IG9wdGlvbnMuaXNTdHJpbmdcbiAgICAgICAgZGVsZXRlIG9wdGlvbnMuaXNTdHJpbmdcbiAgICAgICAgd2hpbGUgKHJlbWFpbmluZ1N0ZXBzID4gMCkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZmlsZVBhdGg6P3N0cmluZyA9IGlzU3RyaW5nICYmIG9wdGlvbnMuZmlsZW5hbWUgfHwgcmVzdWx0XG4gICAgICAgICAgICAgICAgaWYgKGZpbGVQYXRoICYmIHBhdGguZXh0bmFtZShmaWxlUGF0aCkgPT09ICcuanMnKVxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBldmFsKCdyZXF1aXJlJykoZmlsZVBhdGgpXG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghaXNTdHJpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBlbmNvZGluZzpzdHJpbmcgPSBjb25maWd1cmF0aW9uLmVuY29kaW5nXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoJ2VuY29kaW5nJyBpbiBvcHRpb25zKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuY29kaW5nID0gb3B0aW9ucy5lbmNvZGluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZmlsZVN5c3RlbS5yZWFkRmlsZVN5bmMocmVzdWx0LCB7ZW5jb2Rpbmd9KVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZW1haW5pbmdTdGVwcyA9PT0gMSlcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGNvbXByZXNzSFRNTChyZXN1bHQpXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGVqcy5jb21waWxlKHJlc3VsdCwgb3B0aW9ucylcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2VcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBjb21wcmVzc0hUTUwocmVzdWx0KFRvb2xzLmV4dGVuZE9iamVjdCh0cnVlLCB7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24sIEhlbHBlciwgaW5jbHVkZTogcmVxdWlyZSwgcmVxdWlyZSwgVG9vbHNcbiAgICAgICAgICAgICAgICB9LCBsb2NhbHMpKSlcbiAgICAgICAgICAgIHJlbWFpbmluZ1N0ZXBzIC09IDFcbiAgICAgICAgfVxuICAgICAgICBpZiAoQm9vbGVhbihjb21waWxlU3RlcHMgJSAyKSlcbiAgICAgICAgICAgIHJldHVybiBgJ3VzZSBzdHJpY3QnO1xcbmAgKyBiYWJlbFRyYW5zZm9ybShcbiAgICAgICAgICAgICAgICBgbW9kdWxlLmV4cG9ydHMgPSAke3Jlc3VsdC50b1N0cmluZygpfTtgLCB7XG4gICAgICAgICAgICAgICAgICAgIGFzdDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIGJhYmVscmM6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBjb21tZW50czogIUJvb2xlYW4ocXVlcnkuY29tcHJlc3MuamF2YVNjcmlwdCksXG4gICAgICAgICAgICAgICAgICAgIGNvbXBhY3Q6IEJvb2xlYW4ocXVlcnkuY29tcHJlc3MuamF2YVNjcmlwdCksXG4gICAgICAgICAgICAgICAgICAgIGZpbGVuYW1lOiBvcHRpb25zLmZpbGVuYW1lIHx8ICd1bmtub3duJyxcbiAgICAgICAgICAgICAgICAgICAgbWluaWZpZWQ6IEJvb2xlYW4ocXVlcnkuY29tcHJlc3MuamF2YVNjcmlwdCksXG4gICAgICAgICAgICAgICAgICAgIHBsdWdpbnM6IFt0cmFuc2Zvcm1XaXRoXSxcbiAgICAgICAgICAgICAgICAgICAgcHJlc2V0czogcXVlcnkuY29tcHJlc3MuamF2YVNjcmlwdCA/IFtbXG4gICAgICAgICAgICAgICAgICAgICAgICBiYWJpbGlQcmVzZXQsIHF1ZXJ5LmNvbXByZXNzLmphdmFTY3JpcHRcbiAgICAgICAgICAgICAgICAgICAgXV0gOiBbXSxcbiAgICAgICAgICAgICAgICAgICAgc291cmNlTWFwczogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZVR5cGU6ICdzY3JpcHQnXG4gICAgICAgICAgICAgICAgfSkuY29kZVxuICAgICAgICAvLyBJZ25vcmVUeXBlQ2hlY2tcbiAgICAgICAgcmV0dXJuIHJlc3VsdFxuICAgIH1cbiAgICByZXR1cm4gY29tcGlsZShzb3VyY2UsIHtcbiAgICAgICAgY2xpZW50OiBCb29sZWFuKHF1ZXJ5LmNvbXBpbGVTdGVwcyAlIDIpLFxuICAgICAgICBjb21waWxlRGVidWc6IHRoaXMuZGVidWcgfHwgZmFsc2UsXG4gICAgICAgIGRlYnVnOiB0aGlzLmRlYnVnIHx8IGZhbHNlLFxuICAgICAgICBmaWxlbmFtZTogJ3F1ZXJ5JyBpbiB0aGlzID8gbG9hZGVyVXRpbHMuZ2V0UmVtYWluaW5nUmVxdWVzdChcbiAgICAgICAgICAgIHRoaXNcbiAgICAgICAgKS5yZXBsYWNlKC9eIS8sICcnKSA6IHRoaXMuZmlsZW5hbWUgfHwgbnVsbCxcbiAgICAgICAgaXNTdHJpbmc6IHRydWVcbiAgICB9LCBxdWVyeS5jb21waWxlU3RlcHMpKHF1ZXJ5LmxvY2FscyB8fCB7fSlcbn1cbi8vIHJlZ2lvbiB2aW0gbW9kbGluZVxuLy8gdmltOiBzZXQgdGFic3RvcD00IHNoaWZ0d2lkdGg9NCBleHBhbmR0YWI6XG4vLyB2aW06IGZvbGRtZXRob2Q9bWFya2VyIGZvbGRtYXJrZXI9cmVnaW9uLGVuZHJlZ2lvbjpcbi8vIGVuZHJlZ2lvblxuIl19